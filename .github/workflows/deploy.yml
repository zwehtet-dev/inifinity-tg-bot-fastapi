name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/fastapi-bot:latest
          ghcr.io/${{ github.repository }}/fastapi-bot:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        envs: GITHUB_TOKEN,GITHUB_ACTOR,IMAGE_NAME,CONTAINER_NAME
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Login to GitHub Container Registry
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          
          # Pull latest image
          docker pull "$IMAGE_NAME"
          
          # Logout from registry
          docker logout ghcr.io
          
          # Stop and remove old container
          docker stop "$CONTAINER_NAME" 2>/dev/null || true
          docker rm "$CONTAINER_NAME" 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name "$CONTAINER_NAME" \
            --restart unless-stopped \
            -p 8000:8000 \
            --env-file .env \
            --network host \
            "$IMAGE_NAME"
          
          # Clean up old images
          docker image prune -af --filter "until=24h"
          
          # Wait for container to start
          sleep 5
          
          # Check container status
          docker ps | grep "$CONTAINER_NAME"
          docker logs --tail=50 "$CONTAINER_NAME"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}
        IMAGE_NAME: ghcr.io/${{ github.repository }}/fastapi-bot:latest
        CONTAINER_NAME: telegram-bot-fastapi

    - name: Verify deployment
      run: |
        echo "Deployment completed successfully!"
        echo "Image: ghcr.io/${{ github.repository }}/fastapi-bot:${{ github.sha }}"

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Deployment Failed',
            body: `Deployment to ${{ github.event.inputs.environment || 'production' }} failed.\n\nCommit: ${{ github.sha }}\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
          })
